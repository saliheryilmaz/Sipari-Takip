{% extends "store/base.html" %}{% load static %}{% load render_table from django_tables2 %}{% load querystring from django_tables2 %}{% block title %}Purchases{%endblock title%}

{% block content %}
<!-- Header Section -->
<div class="container my-4">
    <div class="card shadow-sm rounded p-3">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h4 class="display-6 mb-0 text-success">Çıkma Lastikler</h4>
            </div>
            <div class="col-md-6 d-flex justify-content-end gap-2">
                <a class="btn btn-success btn-sm rounded-pill shadow-sm" href="{% url 'purchase-create' %}">
                    <i class="fa-solid fa-plus"></i> Yeni Ekle
                </a>
                <a class="btn btn-success btn-sm rounded-pill shadow-sm" href="{% url 'purchases-export' %}">
                    <i class="fa-solid fa-download"></i> Excel'e Aktar
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Arama Bölümü -->
<div class="container my-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label for="searchInput" class="form-label">
                            <i class="fas fa-search"></i> Ürün (Lastik Marka Model) Arama
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="searchInput" 
                               placeholder=""
                               onkeyup="filterTable()">
                        
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-outline-secondary" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Temizle
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <style>
      .table th, .table td {
          text-align: center;
      }
    </style>
    <table id="purchasesTable" class="table table-sm table-striped table-bordered">
        <thead class="thead-light">
            <tr>
                <th scope="col">Durum <i class="fa-solid fa-sort"></i></th>
                <th scope="col">Marka <i class="fa-solid fa-sort"></i></th>
                <th scope="col">Adet <i class="fa-solid fa-sort"></i></th>
                <th scope="col">Ürün (Lastik Marka Model) <i class="fa-solid fa-sort"></i></th>
                <th scope="col">DOT <i class="fa-solid fa-sort"></i></th>
                <th scope="col">Giriş Tarihi <i class="fa-solid fa-sort"></i></th>
                <th scope="col">Mevsim <i class="fa-solid fa-sort"></i></th>
                <th scope="col">Açıklama <i class="fa-solid fa-sort"></i></th>
                <th scope="col">İşlemler</th>
            </tr>
        </thead>
        <tbody>
            {% for purchase in purchases %}
            <tr>
                <td>
                    {% if purchase.durum == 'COK_IYI' %}
                        <span class="badge badge-pill bg-soft-success text-success me-2">
                            Çok İyi
                        </span>
                    {% elif purchase.durum == 'IYI' %}
                        <span class="badge badge-pill bg-soft-info text-info me-2">
                            İyi
                        </span>
                    {% elif purchase.durum == 'ORTA' %}
                        <span class="badge badge-pill bg-soft-warning text-warning me-2">
                            Orta
                        </span>
                    {% elif purchase.durum == 'KOTU' %}
                        <span class="badge badge-pill bg-soft-danger text-danger me-2">
                            Kötü
                        </span>
                    {% else %}
                        <span class="badge badge-pill bg-soft-secondary text-secondary me-2">
                            {{ purchase.durum }}
                        </span>
                    {% endif %}
                </td>
                <td>{{ purchase.marka|default:"-" }}</td>
                <td>{{ purchase.quantity }}</td>
                <td>{{ purchase.urun|default:"-" }}</td>
                <td>{{ purchase.dot|default:"-" }}</td>
                <td>
                    {% if purchase.giris_tarihi %}
                        {{ purchase.giris_tarihi|date:"d.m.Y H:i" }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if purchase.mevsim %}
                        {% if purchase.mevsim == 'YAZ' %}
                            <img src="{% static 'images/seasons/yaz.png' %}" alt="Yaz" width="16" height="16" title="Yaz">
                        {% elif purchase.mevsim == 'KIS' %}
                            <img src="{% static 'images/seasons/kis.png' %}" alt="Kış" width="16" height="16" title="Kış">
                        
                        {% elif purchase.mevsim == '4MEVSIM' %}
                            <img src="{% static 'images/seasons/4mevsim.png' %}" alt="4 Mevsim" width="16" height="16" title="4 Mevsim">
                        {% endif %}
                        {{ purchase.get_mevsim_display }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if purchase.aciklama %}
                        <span title="{{ purchase.aciklama }}">
                            {{ purchase.aciklama|truncatechars:30 }}
                        </span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <a class="text-info me-2" href="{% url 'purchase-update' purchase.id %}" title="Düzenle">
                        <i class="fa-solid fa-pen"></i>
                    </a>
                    <a class="text-danger me-2" href="{% url 'purchase-delete' purchase.id %}" title="Sil">
                        <i class="fa-solid fa-trash"></i>
                    </a>
                    <a class="text-success" href="#" onclick="printPurchaseDetails('{{ purchase.id }}')" title="Yazdır">
                        <i class="fa-solid fa-print"></i>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="mt-4">
        {% if is_paginated %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </span>
                </li>
                {% endif %}
                {% for i in paginator.page_range %}
                {% if page_obj.number == i %}
                <li class="page-item active" aria-current="page">
                    <span class="page-link">{{ i }} <span class="visually-hidden">(current)</span></span>
                </li>
                {% else %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                </li>
                {% endif %}
                {% endfor %}
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </span>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<script>
async function printPurchaseDetails(purchaseId) {
    // Yazdırma için yeni pencere aç
    var printWindow = window.open('', '_blank', 'width=800,height=600');
    
    // Purchase verilerini al
    var purchaseData = await getPurchaseData(purchaseId);
    
    // Yazdırma sayfası içeriği
    var printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Lastik Çıkış Kaydı - #${purchaseId}</title>
            <style>
                body { 
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                    margin: 0; 
                    padding: 30px; 
                    background-color: #f8f9fa;
                    line-height: 1.6;
                }
                .header { 
                    text-align: center; 
                    margin-bottom: 40px; 
                    border-bottom: 3px solid #007bff; 
                    padding-bottom: 20px; 
                    background: linear-gradient(135deg, #007bff, #0056b3);
                    color: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                }
                .header h1 { margin: 0; font-size: 32px; font-weight: 700; }
                .header p { margin: 10px 0 0 0; font-size: 16px; opacity: 0.9; }
                .brand-section { 
                    text-align: center; 
                    margin: 40px 0; 
                    padding: 30px;
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                }
                .brand-name { 
                    font-size: 48px; 
                    font-weight: 800; 
                    color: #2c3e50; 
                    margin: 0;
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
                    letter-spacing: 2px;
                }
                .product-season-section { 
                    display: flex; 
                    justify-content: space-between; 
                    margin: 30px 0; 
                    padding: 25px; 
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
                    border-left: 5px solid #007bff;
                }
                .product-info, .season-info { 
                    flex: 1; 
                    padding: 0 20px; 
                    text-align: center;
                }
                .info-label { 
                    color: #6c757d; 
                    font-size: 14px; 
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    margin-bottom: 8px;
                }
                .info-value { 
                    color: #2c3e50; 
                    font-size: 48px; 
                    font-weight: 700;
                    margin: 0;
                }
                .footer { 
                    margin-top: 40px; 
                    text-align: center; 
                    font-size: 12px; 
                    color: #6c757d;
                    padding: 20px;
                    background: white;
                    border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                }
                @media print { 
                    body { margin: 0; padding: 20px; background: white; } 
                    .no-print { display: none; }
                    .brand-section, .product-season-section, .footer {
                        box-shadow: none;
                        border: 1px solid #ddd;
                    }
                }
            </style>
        </head>
        <body>
            <!-- Marka bölümü - üstte ortalanmış ve büyük -->
            <div class="brand-section">
                <h1 class="brand-name">${purchaseData.marka}</h1>
            </div>
            
            <!-- Ürün ve Mevsim bölümü - yan yana şık tasarım -->
            <div class="product-season-section">
                <div class="product-info">
                    <div class="info-label">Ürün (Lastik Marka Model)</div>
                    <div class="info-value">${purchaseData.urun}</div>
                </div>
                <div class="season-info">
                    <div class="info-label">Mevsim</div>
                    <div class="info-value">${purchaseData.mevsim}</div>
                </div>
            </div>
            
            
            <div class="no-print">
                <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Yazdır</button>
                <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Kapat</button>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
}

function getPurchaseData(purchaseId) {
    // AJAX ile gerçek veriyi çek
    return fetch(`/transactions/purchase/${purchaseId}/data/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error fetching purchase data:', data.error);
                return {
                    durum: 'Hata',
                    marka: '-',
                    adet: '0',
                    urun: 'Veri alınamadı',
                    dot: '-',
                    girisTarihi: '-',
                    mevsim: '-',
                    aciklama: 'Veri yüklenirken hata oluştu'
                };
            }
            return data;
        })
        .catch(error => {
            console.error('Error:', error);
            return {
                durum: 'Hata',
                marka: '-',
                adet: '0',
                urun: 'Veri alınamadı',
                dot: '-',
                girisTarihi: '-',
                mevsim: '-',
                aciklama: 'Veri yüklenirken hata oluştu'
            };
        });
}

// Arama fonksiyonları
function filterTable() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('purchasesTable');
    const tr = table.getElementsByTagName('tr');
    
    // Arama sırasında lastik boyut formatını düzenle
    formatTireSize(input);
    
    for (let i = 1; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName('td');
        let found = false;
        
        // Ürün (Lastik Marka Model) sütununu ara (4. sütun, index 3)
        if (td[3]) {
            const txtValue = td[3].textContent || td[3].innerText;
            if (txtValue.toLowerCase().indexOf(filter) > -1) {
                found = true;
            }
        }
        
        if (found) {
            tr[i].style.display = '';
        } else {
            tr[i].style.display = 'none';
        }
    }
}

function clearSearch() {
    const input = document.getElementById('searchInput');
    input.value = '';
    filterTable();
}

function formatTireSize(input) {
    let value = input.value;
    
    // Lastik boyut formatını düzenle
    // 2055516 t005 -> 205/55R16 t005
    // 2055516t005 -> 205/55R16 t005
    // 205/55/16 t005 -> 205/55R16 t005
    
    // Önce boşlukları normalize et
    value = value.replace(/\s+/g, ' ').trim();
    
    // Lastik boyut pattern'ini bul ve düzenle
    const tireSizePattern = /(\d{3})(\d{2})(\d{2})|(\d{3})\/(\d{2})\/(\d{2})/;
    const match = value.match(tireSizePattern);
    
    if (match) {
        let formattedSize;
        if (match[1] && match[2] && match[3]) {
            // 2055516 formatı
            formattedSize = `${match[1]}/${match[2]}R${match[3]}`;
        } else if (match[4] && match[5] && match[6]) {
            // 205/55/16 formatı
            formattedSize = `${match[4]}/${match[5]}R${match[6]}`;
        }
        
        if (formattedSize) {
            // Orijinal değeri yeni formatla değiştir
            value = value.replace(tireSizePattern, formattedSize);
            input.value = value;
        }
    }
}

// Arama input'una formatlama ekle
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            formatTireSize(e.target);
        });
    }
});
</script>
{% endblock %}
