{% extends 'store/base.html' %}
{% load static %}
{% load currency_filters %}

{% block title %}Lastik Envanteri Listesi{% endblock %}

{% block content %}
<style>
    .table-responsive {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .table {
        margin-bottom: 0;
    }

    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        color: #495057;
        white-space: nowrap;
    }

    .table td {
        vertical-align: middle;
    }

    .btn-group .btn {
        margin-right: 0.25rem;
    }

    .badge {
        font-size: 0.75rem;
    }

    /* Container genişlik optimizasyonları */
    .container-fluid {
        max-width: 98%;
        margin: 0 auto;
    }
    
    @media (min-width: 1200px) {
        .container-fluid {
            max-width: 95%;
        }
    }
    
    @media (min-width: 1400px) {
        .container-fluid {
            max-width: 92%;
        }
    }
    
    @media (max-width: 768px) {
        .container-fluid {
            padding-left: 8px;
            padding-right: 8px;
            max-width: 100%;
        }
        
        .table-responsive {
            font-size: 0.875rem;
        }
        
        .btn-group .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .card-body {
            padding: 1rem;
        }
    }

    @media (max-width: 576px) {
        .table-responsive {
            font-size: 0.75rem;
        }
        
        .btn-group {
            flex-direction: column;
        }
        
        .btn-group .btn {
            margin-bottom: 0.25rem;
            margin-right: 0;
        }
        
        .page-title {
            font-size: 1.25rem;
        }
        
        .breadcrumb {
            font-size: 0.875rem;
        }
    }

    /* Mobile table improvements */
    @media (max-width: 768px) {
        .table td, .table th {
            padding: 0.5rem 0.25rem;
        }
    }
</style>

<div class="container-fluid px-2 px-md-4">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Ana Sayfa</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'lastik-dashboard' %}">Sipariş Dashboard</a></li>
                        <li class="breadcrumb-item active">Sipariş Envanteri</li>
                    </ol>
                </div>
                <h4 class="page-title">Sipariş Envanteri Listesi</h4>
            </div>
        </div>
    </div>

    <!-- Filtreleme Formu -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Filtreleme</h4>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="cari" class="form-label">Cari (Firma)</label>
                            <input type="text" class="form-control" id="cari" name="cari" value="{{ request.GET.cari }}" placeholder="Firma adı...">
                        </div>
                        <div class="col-md-3">
                            <label for="marka" class="form-label">Marka</label>
                            <input type="text" class="form-control" id="marka" name="marka" value="{{ request.GET.marka }}" placeholder="Marka adı...">
                        </div>
                        <div class="col-md-2">
                            <label for="grup" class="form-label">Grup</label>
                            <select class="form-select" id="grup" name="grup">
                                <option value="">Tümü</option>
                                <option value="BINEK" {% if request.GET.grup == 'BINEK' %}selected{% endif %}>Binek</option>
                                <option value="TICARI" {% if request.GET.grup == 'TICARI' %}selected{% endif %}>Ticari</option>
                                <option value="AKU" {% if request.GET.grup == 'AKU' %}selected{% endif %}>Akü</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="durum" class="form-label">Durum</label>
                            <select class="form-select" id="durum" name="durum">
                                <option value="">Tümü</option>
                                <option value="YOLDA" {% if request.GET.durum == 'YOLDA' %}selected{% endif %}>Yolda</option>
                                <option value="ISLEM_DEVAM_EDIYOR" {% if request.GET.durum == 'ISLEM_DEVAM_EDIYOR' %}selected{% endif %}>İşlem Devam Ediyor</option>
                                <option value="TESLIM_EDILDI" {% if request.GET.durum == 'TESLIM_EDILDI' %}selected{% endif %}>Teslim Edildi</option>
                                <option value="KONTROL_EDILDI" {% if request.GET.durum == 'KONTROL_EDILDI' %}selected{% endif %}>Kontrol Edildi</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="mevsim" class="form-label">Mevsim</label>
                            <select class="form-select" id="mevsim" name="mevsim">
                                <option value="">Tümü</option>
                                <option value="YAZ" {% if request.GET.mevsim == 'YAZ' %}selected{% endif %}>Yaz</option>
                                <option value="KIS" {% if request.GET.mevsim == 'KIS' %}selected{% endif %}>Kış</option>
                                <option value="4MEVSIM" {% if request.GET.mevsim == '4MEVSIM' %}selected{% endif %}>4 Mevsim</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="ambar" class="form-label">Ambar</label>
                            <select class="form-select" id="ambar" name="ambar">
                                <option value="">Tümü</option>
                                <option value="STOK" {% if request.GET.ambar == 'STOK' %}selected{% endif %}>Stok</option>
                                <option value="SATIS" {% if request.GET.ambar == 'SATIS' %}selected{% endif %}>Satış</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="tarih_filtresi" class="form-label">Tarih Filtresi</label>
                            <select class="form-select" id="tarih_filtresi" name="tarih_filtresi" onchange="toggleCustomDate()">
                                <option value="">Tümü</option>
                                <option value="1_ay" {% if request.GET.tarih_filtresi == '1_ay' %}selected{% endif %}>Son 1 Ay</option>
                                <option value="3_ay" {% if request.GET.tarih_filtresi == '3_ay' %}selected{% endif %}>Son 3 Ay</option>
                                <option value="6_ay" {% if request.GET.tarih_filtresi == '6_ay' %}selected{% endif %}>Son 6 Ay</option>
                                <option value="custom" {% if request.GET.tarih_filtresi == 'custom' %}selected{% endif %}>Özel Tarih Aralığı</option>
                            </select>
                        </div>
                        <div class="col-md-2" id="baslangic_tarihi_div" style="display: none;">
                            <label for="baslangic_tarihi" class="form-label">Başlangıç Tarihi</label>
                            <input type="date" class="form-control" id="baslangic_tarihi" name="baslangic_tarihi" value="{{ request.GET.baslangic_tarihi }}">
                        </div>
                        <div class="col-md-2" id="bitis_tarihi_div" style="display: none;">
                            <label for="bitis_tarihi" class="form-label">Bitiş Tarihi</label>
                            <input type="date" class="form-control" id="bitis_tarihi" name="bitis_tarihi" value="{{ request.GET.bitis_tarihi }}">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">Filtrele</button>
                            <a href="{% url 'lastik-envanteri-list' %}" class="btn btn-secondary">Temizle</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lastik Envanteri Tablosu -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Sipariş Envanteri</h4>
                    <div class="card-actions">
                        <a href="{% url 'lastik-envanteri-create' %}" class="btn btn-success btn-sm">Yeni Lastik Ekle</a>
                        <a href="{% url 'lastik-dashboard' %}" class="btn btn-info btn-sm">Dashboard</a>
                        <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}_export=xlsx" class="btn btn-warning btn-sm">
                            <i class="fa-solid fa-download me-2"></i>Excel'e Aktar
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Cari (Firma)</th>
                                    <th>Ürün (Lastik Marka Model)</th>
                                    <th>Marka</th>
                                    <th>Grup</th>
                                    <th>Mevsim</th>
                                    <th>Adet</th>
                                    <th>Birim Fiyat</th>
                                    <th>Toplam Fiyat</th>
                                    <th>Durum</th>
                                    <th>Ambar</th>
                                    <th>Açıklama 1</th>
                                    <th>Ödeme</th>
                                    <th>SMS</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lastik in lastikler %}
                                <tr>
                                    <td>{{ lastik.cari }}</td>
                                    <td>
                                        {% if lastik.one_cikar %}
                                            <span style="color: #dc3545; font-weight: bold;">{{ lastik.urun|truncatechars:40 }}</span>
                                        {% else %}
                                            {{ lastik.urun|truncatechars:40 }}
                                        {% endif %}
                                    </td>
                                    <td>{{ lastik.marka }}</td>
                                    <td>
                                        <span class="badge bg-{% if lastik.grup == 'BINEK' %}primary{% elif lastik.grup == 'TICARI' %}warning{% else %}info{% endif %}">
                                            {{ lastik.get_grup_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if lastik.mevsim == 'YAZ' %}warning{% elif lastik.mevsim == 'KIS' %}info{% elif lastik.mevsim == '4MEVSIM' %}success{% else %}secondary{% endif %}">
                                            {{ lastik.get_mevsim_display }}
                                        </span>
                                    </td>
                                    <td>{{ lastik.adet }}</td>
                                    <td>{{ lastik.birim_fiyat|turkish_currency }}</td>
                                    <td>{{ lastik.toplam_fiyat|turkish_currency }}</td>
                                    <td>
                                        <span class="badge bg-{% if lastik.durum == 'YOLDA' %}info{% elif lastik.durum == 'ISLEM_DEVAM_EDIYOR' %}warning{% elif lastik.durum == 'TESLIM_EDILDI' %}success{% elif lastik.durum == 'KONTROL_EDILDI' %}primary{% else %}secondary{% endif %}">
                                            {{ lastik.get_durum_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if lastik.ambar == 'STOK' %}primary{% else %}success{% endif %}">
                                            {{ lastik.get_ambar_display }}
                                        </span>
                                    </td>
                                    <td>{{ lastik.aciklama1|truncatechars:20|default:"-" }}</td>
                                    <td>{{ lastik.get_odeme_display|default:"-" }}</td>
                                    <td>
                                        {% if lastik.sms_gonderildi %}
                                            <span class="badge bg-success">Gönderildi</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Gönderilmedi</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'lastik-envanteri-detail' lastik.pk %}" class="btn btn-sm btn-info">
                                                Detay
                                            </a>
                                            <a href="{% url 'lastik-envanteri-update' lastik.pk %}" class="btn btn-sm btn-warning">
                                                Düzenle
                                            </a>
                                            <button onclick="whatsappGonder('{{ lastik.pk }}')" class="btn btn-sm btn-success">
                                                WhatsApp
                                            </button>
                                            <a href="{% url 'lastik-envanteri-delete' lastik.pk %}" class="btn btn-sm btn-danger" onclick="return confirm('Bu lastiği silmek istediğinizden emin misiniz?')">
                                                Sil
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="14" class="text-center">Henüz lastik eklenmemiş</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Sayfalama -->
                    {% if is_paginated %}
                    <nav aria-label="Lastik envanteri sayfalama">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if request.GET.cari %}&cari={{ request.GET.cari }}{% endif %}{% if request.GET.marka %}&marka={{ request.GET.marka }}{% endif %}{% if request.GET.grup %}&grup={{ request.GET.grup }}{% endif %}{% if request.GET.mevsim %}&mevsim={{ request.GET.mevsim }}{% endif %}{% if request.GET.durum %}&durum={{ request.GET.durum }}{% endif %}{% if request.GET.ambar %}&ambar={{ request.GET.ambar }}{% endif %}{% if request.GET.tarih_filtresi %}&tarih_filtresi={{ request.GET.tarih_filtresi }}{% endif %}{% if request.GET.baslangic_tarihi %}&baslangic_tarihi={{ request.GET.baslangic_tarihi }}{% endif %}{% if request.GET.bitis_tarihi %}&bitis_tarihi={{ request.GET.bitis_tarihi }}{% endif %}">İlk</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.cari %}&cari={{ request.GET.cari }}{% endif %}{% if request.GET.marka %}&marka={{ request.GET.marka }}{% endif %}{% if request.GET.grup %}&grup={{ request.GET.grup }}{% endif %}{% if request.GET.mevsim %}&mevsim={{ request.GET.mevsim }}{% endif %}{% if request.GET.durum %}&durum={{ request.GET.durum }}{% endif %}{% if request.GET.ambar %}&ambar={{ request.GET.ambar }}{% endif %}{% if request.GET.tarih_filtresi %}&tarih_filtresi={{ request.GET.tarih_filtresi }}{% endif %}{% if request.GET.baslangic_tarihi %}&baslangic_tarihi={{ request.GET.baslangic_tarihi }}{% endif %}{% if request.GET.bitis_tarihi %}&bitis_tarihi={{ request.GET.bitis_tarihi }}{% endif %}">Önceki</a>
                                </li>
                            {% endif %}

                            <li class="page-item active">
                                <span class="page-link">
                                    Sayfa {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.cari %}&cari={{ request.GET.cari }}{% endif %}{% if request.GET.marka %}&marka={{ request.GET.marka }}{% endif %}{% if request.GET.grup %}&grup={{ request.GET.grup }}{% endif %}{% if request.GET.mevsim %}&mevsim={{ request.GET.mevsim }}{% endif %}{% if request.GET.durum %}&durum={{ request.GET.durum }}{% endif %}{% if request.GET.ambar %}&ambar={{ request.GET.ambar }}{% endif %}{% if request.GET.tarih_filtresi %}&tarih_filtresi={{ request.GET.tarih_filtresi }}{% endif %}{% if request.GET.baslangic_tarihi %}&baslangic_tarihi={{ request.GET.baslangic_tarihi }}{% endif %}{% if request.GET.bitis_tarihi %}&bitis_tarihi={{ request.GET.bitis_tarihi }}{% endif %}">Sonraki</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.cari %}&cari={{ request.GET.cari }}{% endif %}{% if request.GET.marka %}&marka={{ request.GET.marka }}{% endif %}{% if request.GET.grup %}&grup={{ request.GET.grup }}{% endif %}{% if request.GET.mevsim %}&mevsim={{ request.GET.mevsim }}{% endif %}{% if request.GET.durum %}&durum={{ request.GET.durum }}{% endif %}{% if request.GET.ambar %}&ambar={{ request.GET.ambar }}{% endif %}{% if request.GET.tarih_filtresi %}&tarih_filtresi={{ request.GET.tarih_filtresi }}{% endif %}{% if request.GET.baslangic_tarihi %}&baslangic_tarihi={{ request.GET.baslangic_tarihi }}{% endif %}{% if request.GET.bitis_tarihi %}&bitis_tarihi={{ request.GET.bitis_tarihi }}{% endif %}">Son</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function whatsappGonder(lastikId) {
    fetch(`/lastik-envanteri/${lastikId}/whatsapp/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.open(data.whatsapp_url, '_blank');
        } else {
            alert('Hata: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata oluştu');
    });
}

function toggleCustomDate() {
    const tarihFiltresi = document.getElementById('tarih_filtresi');
    const baslangicDiv = document.getElementById('baslangic_tarihi_div');
    const bitisDiv = document.getElementById('bitis_tarihi_div');
    
    if (tarihFiltresi.value === 'custom') {
        baslangicDiv.style.display = 'block';
        bitisDiv.style.display = 'block';
    } else {
        baslangicDiv.style.display = 'none';
        bitisDiv.style.display = 'none';
    }
}

// Filtreleme alanları için otomatik büyük harf dönüşümü
function convertToUpperCase(input) {
    input.value = input.value.toUpperCase();
}

// Cari ve Marka alanları için büyük harf dönüşümü
const cariInput = document.getElementById('cari');
const markaInput = document.getElementById('marka');

if (cariInput) {
    cariInput.addEventListener('input', function() {
        convertToUpperCase(this);
    });
}

if (markaInput) {
    markaInput.addEventListener('input', function() {
        convertToUpperCase(this);
    });
}

// Sayfa yüklendiğinde özel tarih alanlarını kontrol et
document.addEventListener('DOMContentLoaded', function() {
    toggleCustomDate();
});
</script>
{% endblock %}

